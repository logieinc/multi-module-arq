name: napa-dev

x-node-service: &node-service
  image: node:20
  restart: unless-stopped
  networks:
    - napa-network
  environment:
    NODE_ENV: development
  tty: true

services:
  nginx:
    image: nginx:1.25-alpine
    ports:
      - "${NGINX_PORT:-3000}:80"
    environment:
      AUTHORIZER_PORT: "${AUTHORIZER_PORT:-5108}"
      API_AUTH_PORT: "${API_AUTH_PORT:-5208}"
      API_SECURITY_PORT: "${API_SECURITY_PORT:-5308}"
      API_WALLET_PORT: "${API_WALLET_PORT:-4606}"
      API_PLAYERV2_PORT: "${API_PLAYERV2_PORT:-4000}"
      API_DEVOPS_PORT: "${API_DEVOPS_PORT:-3408}"
      STOREFRONT_GAMES_PORT: "${STOREFRONT_GAMES_PORT:-4200}"
    volumes:
      # Use the rendered config directly. The template requires NGINX_SERVICE_LOCATIONS,
      # which is generated by dev-shell and written into config/nginx/default.conf.
      - ${WORKSPACE_ROOT:-.}/config/nginx/default.conf:/etc/nginx/conf.d/default.conf:ro
    depends_on:
      - authorizer
      - api-auth
      - api-security
      - api-wallet
      - api-playerv2
      - api-devops
      - storefront-games
    restart: unless-stopped
    networks:
      - napa-network

  authorizer:
    <<: *node-service
    container_name: authorizer
    working_dir: /workspace/repos/authorizer
    command: sh -c "npm install ts-node-dev@^2.0.0 --no-save --quiet || true; export PATH=/workspace/repos/authorizer/node_modules/.bin:$$PATH; ${AUTHORIZER_CMD:-npm run debug -- --host=0.0.0.0}"
    env_file:
      - repos/authorizer/.env.${STACK_ENV:-local}
    volumes:
      - ${WORKSPACE_ROOT:-.}/repos/authorizer:/workspace/repos/authorizer
      - authorizer_node_modules:/workspace/repos/authorizer/node_modules
    ports:
      - "${AUTHORIZER_PORT:-5108}:${AUTHORIZER_PORT:-5108}"
      - "${AUTHORIZER_DEBUG_PORT:-5110}:9229"

  api-auth:
    <<: *node-service
    container_name: api-auth
    working_dir: /workspace/repos/api-auth
    command: sh -c "npm install ts-node-dev@^2.0.0 --no-save --quiet || true; export PATH=/workspace/repos/api-auth/node_modules/.bin:$$PATH; ${API_AUTH_CMD:-npm run devx -- --host=0.0.0.0}"
    env_file:
      - repos/api-auth/.env.${STACK_ENV:-local}
    volumes:
      - ${WORKSPACE_ROOT:-.}/repos/api-auth:/workspace/repos/api-auth
      - api_auth_node_modules:/workspace/repos/api-auth/node_modules
    ports:
      - "${API_AUTH_PORT:-5208}:${API_AUTH_PORT:-5208}"
      - "${API_AUTH_DEBUG_PORT:-5210}:9229"

  api-security:
    <<: *node-service
    container_name: api-security
    working_dir: /workspace/repos/api-security
    command: sh -c "npm install ts-node-dev@^2.0.0 --no-save --quiet || true; export PATH=/workspace/repos/api-security/node_modules/.bin:$$PATH; ${API_SECURITY_CMD:-npm run start:debug -- --host=0.0.0.0}"
    env_file:
      - repos/api-security/.env.${STACK_ENV:-local}
    volumes:
      - ${WORKSPACE_ROOT:-.}/repos/api-security:/workspace/repos/api-security
      - api_security_node_modules:/workspace/repos/api-security/node_modules
    ports:
      - "${API_SECURITY_PORT:-5308}:${API_SECURITY_PORT:-5308}"
      - "${API_SECURITY_DEBUG_PORT:-5310}:9229"

  api-wallet:
    <<: *node-service
    container_name: api-wallet
    working_dir: /workspace/repos/api-wallet
    command: sh -c "npm install ts-node-dev@^2.0.0 --no-save --quiet || true; export PATH=/workspace/repos/api-wallet/node_modules/.bin:$$PATH; ${API_WALLET_CMD:-npm run devx -- --host=0.0.0.0}"
    env_file:
      - repos/api-wallet/.env.${STACK_ENV:-local}
    volumes:
      - ${WORKSPACE_ROOT:-.}/repos/api-wallet:/workspace/repos/api-wallet
      - api_wallet_node_modules:/workspace/repos/api-wallet/node_modules
    ports:
      - "${API_WALLET_PORT:-4606}:${API_WALLET_PORT:-4606}"
      - "${API_WALLET_DEBUG_PORT:-4610}:9229"

  api-playerv2:
    <<: *node-service
    container_name: api-playerv2
    working_dir: /workspace/repos/api-playerv2
    command: sh -c "npm install ts-node-dev@^2.0.0 --no-save --quiet || true; export PATH=/workspace/repos/api-playerv2/node_modules/.bin:$$PATH; ${API_PLAYERV2_CMD:-nodemon}"
    env_file:
      - repos/api-playerv2/.env.${STACK_ENV:-local}
    volumes:
      - ${WORKSPACE_ROOT:-.}/repos/api-playerv2:/workspace/repos/api-playerv2
      - api_playerv2_node_modules:/workspace/repos/api-playerv2/node_modules
    ports:
      - "${API_PLAYERV2_PORT:-4000}:${API_PLAYERV2_PORT:-4000}"
      - "${API_PLAYERV2_DEBUG_PORT:-4010}:9229"

  api-devops:
    <<: *node-service
    container_name: api-devops
    working_dir: /workspace/repos/devops-module/api-devops
    command: sh -c "npm install ts-node-dev@^2.0.0 --no-save --quiet || true; export PATH=/workspace/repos/devops-module/api-devops/node_modules/.bin:$$PATH; ${API_DEVOPS_CMD:-ts-node-dev --respawn --inspect=0.0.0.0:9229 --pretty --transpile-only src/index.ts}"
    env_file:
      - repos/devops-module/api-devops/.env
    volumes:
      - ${WORKSPACE_ROOT:-.}/repos/devops-module/api-devops:/workspace/repos/devops-module/api-devops
      - api_devops_node_modules:/workspace/repos/devops-module/api-devops/node_modules
    ports:
      - "${API_DEVOPS_PORT:-3408}:${API_DEVOPS_PORT:-3408}"
      - "${API_DEVOPS_DEBUG_PORT:-3410}:9229"

  storefront-games:
    <<: *node-service
    container_name: storefront-games
    working_dir: /workspace/repos/storefront-games
    command: sh -c "npm install ts-node-dev@^2.0.0 --no-save --quiet || true; export PATH=/workspace/repos/storefront-games/node_modules/.bin:$$PATH; ${STOREFRONT_GAMES_CMD:-npm install --quiet && node --inspect=0.0.0.0:9229 ./node_modules/@angular/cli/bin/ng serve --configuration=metro-local --host=0.0.0.0 --port=4200 --allowed-hosts=localhost --allowed-hosts=storefront-games}"
    env_file:
      - repos/storefront-games/.env.${STACK_ENV:-local}
    volumes:
      - ${WORKSPACE_ROOT:-.}/repos/storefront-games:/workspace/repos/storefront-games
      - storefront_games_node_modules:/workspace/repos/storefront-games/node_modules
    ports:
      - "${STOREFRONT_GAMES_PORT:-4200}:${STOREFRONT_GAMES_PORT:-4200}"
      - "${STOREFRONT_GAMES_DEBUG_PORT:-4210}:9229"
    depends_on:
      - api-playerv2

  security-postgresql:
    image: postgres:14
    profiles: ["db-security"]
    container_name: security-postgresql
    restart: unless-stopped
    environment:
      POSTGRES_USER: "${SECURITY_DB_USER:-security}"
      POSTGRES_PASSWORD: "${SECURITY_DB_PASSWORD:-security}"
      POSTGRES_DB: "${SECURITY_DB_NAME:-security}"
    ports:
      - "${SECURITY_DB_PORT:-5433}:5432"
    volumes:
      - security_pg_data:/var/lib/postgresql/data
    networks:
      - napa-network

  auth-postgresql:
    image: postgres:14
    profiles: ["db-auth"]
    container_name: auth-postgresql
    restart: unless-stopped
    environment:
      POSTGRES_USER: "${AUTH_DB_USER:-auth}"
      POSTGRES_PASSWORD: "${AUTH_DB_PASSWORD:-auth}"
      POSTGRES_DB: "${AUTH_DB_NAME:-auth}"
    ports:
      - "${AUTH_DB_PORT:-5434}:5432"
    volumes:
      - auth_pg_data:/var/lib/postgresql/data
    networks:
      - napa-network

  wallet-postgresql:
    image: postgres:14
    profiles: ["db-wallet"]
    container_name: wallet-postgresql
    restart: unless-stopped
    environment:
      POSTGRES_USER: "${WALLET_DB_USER:-wallet}"
      POSTGRES_PASSWORD: "${WALLET_DB_PASSWORD:-wallet}"
      POSTGRES_DB: "${WALLET_DB_NAME:-wallet}"
    ports:
      - "${WALLET_DB_PORT:-5435}:5432"
    volumes:
      - wallet_pg_data:/var/lib/postgresql/data
    networks:
      - napa-network

volumes:
  authorizer_node_modules:
  api_auth_node_modules:
  api_security_node_modules:
  api_wallet_node_modules:
  api_playerv2_node_modules:
  api_devops_node_modules:
  storefront_games_node_modules:
  security_pg_data:
  auth_pg_data:
  wallet_pg_data:

networks:
  napa-network:
    driver: bridge
