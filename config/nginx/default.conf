
server {
  listen 80;
  server_name _;

  # Buffers y headers para requests grandes en dev
  proxy_buffer_size 128k;
  proxy_buffers 4 256k;
  proxy_busy_buffers_size 256k;
  client_header_buffer_size 8k;
  large_client_header_buffers 16 128k;
  ignore_invalid_headers off;

  set $forwarded_proto $http_x_forwarded_proto;
  if ($forwarded_proto = '') {
    set $forwarded_proto $scheme;
  }

  location /health {
    return 200 "ok\n";
  }

  location /authorizer/ {
    proxy_pass_request_headers on;
    proxy_set_header Host             $host;
    proxy_set_header X-Real-IP        $remote_addr;
    proxy_set_header X-Real-URI       $request_uri;
    proxy_set_header X-Real-Method    $request_method;
    proxy_set_header X-Real-Host      $host;
    proxy_set_header X-Forwarded-For  $proxy_add_x_forwarded_for;
    proxy_set_header X-Forwarded-Proto $forwarded_proto;
    rewrite ^/authorizer/?(.*)$ /$1 break;
    proxy_pass http://authorizer:5108;
  }

  location = /api-auth/health {
    return 204;
  }

  location /api-auth/login/auth {
    rewrite ^/api-auth/(.*) /$1 break;
    proxy_pass http://api-auth:5208;
  }

  location = /api-auth/user/password-reset-code {
    rewrite ^/api-auth/(.*) /$1 break;
    proxy_pass http://api-auth:5208;
  }

  location = /api-auth/user/reset-password {
    rewrite ^/api-auth/(.*) /$1 break;
    proxy_pass http://api-auth:5208;
  }

  location ~ ^/api-auth/(login|user)/ {
    # send the url and the request method to the auth_request
    auth_request     /authorizer;
    auth_request_set $auth_status $upstream_status;
    auth_request_set $auth_user $upstream_http_x_auth_user;
    auth_request_set $auth_decoded_token $upstream_http_x_decoded_token;
    proxy_set_header X-Auth-User $auth_user;
    proxy_set_header X-Auth-Decoded-Token $auth_decoded_token;
    rewrite ^/api-auth/(.*) /$1 break;
    proxy_pass http://api-auth:5208;
  }

  location = /authorizer {
    internal;
    proxy_pass_request_headers on;
    proxy_set_header X-Real-URI $request_uri;
    proxy_set_header X-Real-Method $request_method;
    proxy_set_header X-Real-Host $host;
    rewrite ^/authorizer/(.*) /$1 break;
    proxy_pass http://authorizer:5108;
  }

  location = /health {
    return 204;
  }

  location /login/ {
    proxy_set_header Host             $host;
    proxy_set_header X-Forwarded-For  $proxy_add_x_forwarded_for;
    proxy_set_header X-Forwarded-Proto $forwarded_proto;
    proxy_pass http://api-auth:5208;
  }

  location /user/ {
    proxy_set_header Host             $host;
    proxy_set_header X-Forwarded-For  $proxy_add_x_forwarded_for;
    proxy_set_header X-Forwarded-Proto $forwarded_proto;
    proxy_pass http://api-auth:5208;
  }

  location /api-security/ {
    # send the url and the request method to the auth_request
    auth_request     /authorizer;
    auth_request_set $auth_status $upstream_status;
    auth_request_set $auth_user $upstream_http_x_auth_user;
    auth_request_set $auth_decoded_token $upstream_http_x_decoded_token;
    proxy_set_header X-Auth-User $auth_user;
    proxy_set_header X-Auth-Decoded-Token $auth_decoded_token;
    rewrite ^/api-security/(.*) /$1 break;
    proxy_pass http://api-security:5308;
  }

  location /api-wallet/ {
    proxy_set_header Host             $host;
    proxy_set_header X-Forwarded-For  $proxy_add_x_forwarded_for;
    proxy_set_header X-Forwarded-Proto $forwarded_proto;
    rewrite ^/api-wallet/?(.*)$ /$1 break;
    proxy_pass http://api-wallet:4606;
  }

  location /api-playerv2/ {
    proxy_set_header Host             $host;
    proxy_set_header X-Forwarded-For  $proxy_add_x_forwarded_for;
    proxy_set_header X-Forwarded-Proto $forwarded_proto;
    rewrite ^/api-playerv2/?(.*)$ /$1 break;
    proxy_pass http://api-playerv2:4000;
  }

  location /api-devops/ {
    proxy_set_header Host             $host;
    proxy_set_header X-Forwarded-For  $proxy_add_x_forwarded_for;
    proxy_set_header X-Forwarded-Proto $forwarded_proto;
    rewrite ^/api-devops/?(.*)$ /$1 break;
    proxy_pass http://api-devops:3408;
  }

  location /storefront-games/ {
    proxy_set_header Host             $host;
    proxy_set_header X-Forwarded-For  $proxy_add_x_forwarded_for;
    proxy_set_header X-Forwarded-Proto $forwarded_proto;
    rewrite ^/storefront-games/?(.*)$ /$1 break;
    proxy_pass http://storefront-games:4200;
  }
}
